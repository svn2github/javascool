#####################################################################################################################################
##  Philoumailabo@gmail.com and Thierry.Vieville@sophia.inria.fr, Copyright (C) 2010.  All rights reserved.                        ##
#####################################################################################################################################

dft: 
	rm -f src/org/javascool/xslt/xml2pml.java
	$(MAKE) v2

usage :
	@echo 'Usage:'
	@echo ' make clean        : nettoie les fichiers intermédiares'
	@echo ' make j3           : lance la v3 de javascool à partir du jar'
	@echo ' make v3           : lance la v3 de javascool à partir des classes compilées'
	@echo ' make svn          : synchronize avec le svn'
	@echo ' make doc          : cree la doc des classes java'
	@echo ' make pub          : publie les fichiers du site web'

clean:
	@rm -rf `find . -name '*.class'` tmp lib/manifest.mf www/api www/javascool.jar .http.root src/org/javascool/xslt/page.htm

j3: www/javascool.jar
	cd tst ; java -jar ../www/javascool.jar

v2: www/javascool.jar
	#@cd tst ; java -cp ../www/javascool.jar org.javascool.MainV2 # edit javaprog TestMeVe.jvs
	@cd tst ; java -cp ../www/javascool.jar org.javascool.AlgoTree

v3: cmp
	@java -cp src:lib/tools.jar:lib/saxon.jar org.javascool.Main

Pml: cmp
	@java -cp src:lib/tools.jar:lib/saxon.jar org.javascool.Pml $(file)

svn: clean
	svn up ; svn ci -m '' ; svn status

doc: www/api/index.html
	@firefox www/api/org/javascool/package-summary.html

pub: www/api/index.html www/javascool.jar
	@php -l www/index.php ; rm -f www/index.php~
	@-rsync --rsh='ssh -C' --archive --delete-excluded --exclude .svn/ www/* scm.gforge.inria.fr:/home/groups/javascool/htdocs/v3 2>&1 | grep -v '^rsync: failed to set'
	@echo 'Si www/index.php a change la page http://javascool.gforge.inria.fr/v3 sera accessible dans environ une heure'

#####################################################################################################################################

# Creation of a signed jar for standalone applications integrating the jdk5 classes

J5=/usr/java/jdk1.5.0_13

# Jar meta-data

vendor=thierry.vieville@sophia.inria.fr, ou=javascool.gforge.inria.fr, o=inria.fr, c=fr
version=3.0
public-key=hello-world
private-key=mer,d,azof

SRC=$(shell find src -name '*.java')

www/javascool.jar : makefile lib/tools.jar lib/saxon.jar lib/manifest.mf srcs $(SRC)
	@echo "make $@"
	@#[1] Compile the java classes
	@$(J5)/bin/javac -Xlint -cp lib/tools.jar $(SRC)
	@#[2] Collects the files in a tmp directory
	@rm -rf tmp ; svn -q export src tmp ; 
	@for f in `find src -name '*.class'` ; do cp $$f `echo $$f | sed 's/^src/tmp/'` ; done
	@# + The jdk5 compiler classes
	@unzip -qod tmp lib/tools.jar 
	@# + The saxon transformer classes
	@unzip -qod tmp lib/saxon.jar
	@#Build the raw jar
	@cd tmp ; jar cfm ../tmp.jar ../lib/manifest.mf org proglet com/sun/tools/javac sun/tools/javac com/icl/saxon org/w3c/xsl META-INF/services
	@#Sign the jar file
	@keytool -genkey -alias javascool -validity 3000 -dname cn='$(vendor)' -storepass '$(public-key)' -keypass '$(private-key)' -keystore tmp.key
	@jarsigner -storepass '$(public-key)' -keypass '$(private-key)' -keystore tmp.key -signedjar $@ tmp.jar javascool
	@#Optional verification commands
	@#-keytool -export -alias proglet -storepass '$(public-key)' -keystore tmp.key -file javascool.crt
	@#-jarsigner -verify -verbose -certs $@
	@#Cleanup
	@rm -rf tmp tmp.key tmp.jar javascool.crt 
	@echo ".. done: size = `du -s -B 1024 $@ | awk '{print $$1}'`Kbytes"

lib/manifest.mf : makefile
	@(echo 'Summary: javascool v3'; echo 'Created-By: $(version) (javascool.gforge.inria.fr © creative-commons)' ; echo "Manifest-version: `date '+%Y:%m:%d'`") > $@
	@(echo 'Main-Class: org.javascool.Main') >> $@
	@(echo 'Implementation-Vendor: $(vendor)'; echo 'Implementation-URL: http://javascool.gforge.inria.fr' ; echo 'Implementation-Version: $(version)') >> $@

cmp : srcs $(SRC)
	@rm -f $@; javac -Xlint -cp src:lib/tools.jar:lib/saxon.jar $(SRC)

srcs : src/org/javascool/Proglets.java # $(patsubst %.xslt,%.java,$(shell find src -name '*.xslt')) 

%.java : %.xslt
	@echo '/* Automatically generated by the makefile: DO NOT EDIT !*/ package org.javascool; class $(*F) { static String xsl = ' > $@
	@cat $^ | sed 's/"/\\"/g' | sed 's/\(.*\)/"\1\\n"+/' >> $@
	@echo '"";}' >> $@ 	

src/org/javascool/Proglets.java : $(shell find src/proglet -name '*.java')
	@echo '/* Automatically generated by the makefile: DO NOT EDIT !*/ package org.javascool; class Proglets { static String proglets[] = {' > $@
	@for f in `egrep -l 'implements[ \t]+(org.javascool.)?Proglet' $^` ; do echo $$f | sed 's/^src\/\(.*\)\.java$$/"\1",/' | sed 's/\//./g' ; done >> $@
	@echo '""}; }' >> $@

CP=/usr/java/jdk1.5.0_13/lib/tools.jar

lib/tools.jar : $(CP)
	@cp $^ $@

SX=/home/vthierry/bin/saxon.jar

lib/saxon.jar : $(SX)
	@cp $^ $@

#####################################################################################################################################

# Java doc generation

www/api/index.html : htms pmls pngs $(shell find src -name package.html) $(SRC)
	@echo "make $(@D)"
	@rm -rf  $(@D) ; mkdir -p $(@D)
	@for f in $(SRC) ; do mv $$f $$f.bak ; sed 's/\/\*\*\/ *public/\/\*public\*\//g' < $$f.bak > $$f ; touch -r $$f.bak $$f ; done
	@javadoc -quiet -public -nohelp -nodeprecated -nonavbar -nosince -notree -noindex -author -use -link http://download.oracle.com/javase/6/docs/api \
	 -windowtitle "Java's Cool v3" -d $(@D) $(SRC)
	@for f in $(SRC) ; do mv $$f $$f.bak ; sed 's/\/\*public\*\//\/\*\*\/public/g' < $$f.bak > $$f ; touch -r $$f.bak $$f ; rm $$f.bak ; done
	@for f in $(SRC) $(shell find src -name doc-files) ; do cp -r $$f `echo $$f | sed 's/^src/$(subst /,\\/,$(@D))/'` ; done

htms : $(patsubst %.xml,%.htm,$(shell find src -name '*.xml'))

%.htm : %.xml lib/xml2htm.xsl
	@java -jar lib/saxon.jar -o $@ $^

pmls : $(patsubst %.xml,%.pml,$(shell find src -name '*.xml'))

%.pml : %.xml cmp
	@java -cp src:lib/tools.jar:lib/saxon.jar org.javascool.Pml $*.xml > $@

pmls-clean :
	rm -f $(patsubst %.xml,%.pml,$(shell find src -name '*.xml'))

pngs :  $(patsubst %.fig,%.png,$(shell find src -name '*.fig')) 

%.png : %.fig
	@fig2dev -L png $^ > $@

#####################################################################################################################################

# System operation commands

ftp :
	gnome-terminal -e 'sftp scm.gforge.inria.fr:/home/groups/javascool/htdocs'

web:
	@firefox http://javascool.gforge.inria.fr/v3

wiki:
	@firefox http://wiki.inria.fr/sciencinfolycee

php:
	@php -l www/index.php
	@make -f /home/vthierry/Work/enas/src/yava/makefile.http ROOT=`pwd`/www PAGE=index.php?page=api:org/javascool/package-summary.html show

# Useful commands:
#
# - svn up ; svn resolve --accept working . 
#

#####################################################################################################################################
