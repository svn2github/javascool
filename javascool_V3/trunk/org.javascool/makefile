# <a href="#readme">readme</a><pre>

#####################################################################################################################################
##  Philoumailabo@gmail.com and Thierry.Vieville@sophia.inria.fr, Copyright (C) 2010.  All rights reserved.                        ##
#####################################################################################################################################

default : j3

# General commands

usage :
	@grep '^#::' makefile | sed 's/^#:://'

what :
	@grep '^#:' makefile | sed 's/^#://'

v3: cmp
	@cd tst ; ../lib/run.sh  org.javascool.Main

j3: jar
	@cd tst ; java -jar ../www/javascool.jar

doc: api
	firefox file:www/api/org/javascool/package-summary.html

svn: clean
	svn up ; svn ci -m '' ; svn status

clean:
	@rm -rf `find . -name '*.class'` tmp tmp.* tst/tmp.* .http.root www/.htcache lib/manifest.mf www/api www/javascool.jar www/sources.zip

#####################################################################################################################################

# Creation of a signed jar for standalone applications integrating the jdk5 classes

jar : www/javascool.jar

# Jar parameters, files and meta-data

J5=/usr/java/jdk1.5.0_22

vendor=thierry.vieville@sophia.inria.fr, ou=javascool.gforge.inria.fr, o=inria.fr, c=fr
version=3.0
public-key=hello-world
private-key=mer,d,azof
revision=$(shell svn info | grep '^R.vision:' | sed 's/^R.vision: *//')

SRC = \
 $(shell find src -name '*.java') \
 src/org/javascool/proglets.java  $(patsubst %.xslt,%.java,$(shell find src -name '*.xslt'))

XSL = \
 $(shell find src -name '*.xslt')

DOC = \
 $(patsubst %.fig,%.png,$(shell find src -name '*.fig')) src/org/javascool/doc-files/revision.xml $(patsubst %.xml,%.htm,$(shell find src -name '*.xml'))

JVS = \
  src/proglet/javaprog/FleurEnRythme.jvs

CP=src:lib/tools.jar:lib/saxon.jar

# Compiles the java classes using the default jdk5 and builds the certified jar

www/javascool.jar : makefile lib/tools.jar lib/saxon.jar lib/manifest.mf $(SRC) $(JVS) htm
	@echo "make $@"
	@#[1] Compile the java classes
	@$(J5)/bin/javac -Xlint -cp $(CP) $(SRC)
	@#[2] Collects the files in a tmp directory
	@rm -rf tmp ; svn -q export src tmp ; 
	@for f in `find src -name '*.class'` ; do cp $$f `echo $$f | sed 's/^src/tmp/'` ; done
	@# + The jdk5 compiler classes
	@unzip -qod tmp lib/tools.jar 
	@# + The saxon transformer classes
	@unzip -qod tmp lib/saxon.jar
	@#Build the raw jar
	@cd tmp ; jar cfm ../tmp.jar ../lib/manifest.mf org proglet com/sun/tools/javac sun/tools/javac com/icl/saxon org/w3c/xsl META-INF/services
	@#Sign the jar file
	@keytool -genkey -alias javascool -validity 3000 -dname cn='$(vendor)' -storepass '$(public-key)' -keypass '$(private-key)' -keystore tmp.key
	@jarsigner -storepass '$(public-key)' -keypass '$(private-key)' -keystore tmp.key -signedjar $@ tmp.jar javascool
	@#Optional verification commands
	@#-keytool -export -alias proglet -storepass '$(public-key)' -keystore tmp.key -file javascool.crt
	@#-jarsigner -verify -verbose -certs $@
	@#Cleanup
	@rm -rf tmp tmp.key tmp.jar javascool.crt 
	@echo ".. done: size = `du -s -B 1024 $@ | awk '{print $$1}'`Kbytes"

lib/manifest.mf : makefile
	@(echo 'Summary: javascool v3'; echo 'Created-By: $(version) (javascool.gforge.inria.fr © creative-commons)' ; echo "Manifest-version: `date '+%Y:%m:%d'` revision #$(revision)") > $@
	@(echo 'Main-Class: org.javascool.Main') >> $@
	@(echo 'Implementation-Vendor: $(vendor)'; echo 'Implementation-URL: http://javascool.gforge.inria.fr' ; echo 'Implementation-Version: $(version)') >> $@

htm : $(DOC)

%.htm : %.xml src/org/javascool/hdoc2htm.xslt
	@java -jar lib/saxon.jar -o $@ $^

src/org/javascool/hdoc2htm.xslt : src/org/javascool/hml2htm.xslt
	@touch $@

%.png : %.fig
	@fig2dev -L png $^ > $@

src/org/javascool/doc-files/revision.xml : makefile .svn
	@touch src/org/javascool/doc-files/about-main.xml
	@echo "<!-- Automatically generated by the makefile: DO NOT EDIT ! --> <p class=\"margin\"><c>Java'Scool v3.0-beta, révision: <i>$(revision)</i></c> </p>" > $@

# Compiles the java classes using the default jdk 

cmp : $(SRC)
	@rm -f $@; javac -Xlint -cp $(CP) $(SRC)

# Automatically generated java files

%.java : %.jvs
	@echo "jvs2java $*"
	@javac -Xlint -cp $(CP) $(shell find src/org/javascool -name '*.java') $(shell find src/proglet/ingredients -name '*.java') 
	@java -cp $(CP) org.javascool.Jvs2Java $*

%.java : %.xslt
	@echo "<div/>" > /tmp/null.xml ; java -jar lib/saxon.jar -o /tmp/null.htm /tmp/null.xml $^ ; rm -f /tmp/null.xml /tmp/null.htm
	@echo '/* Automatically generated by the makefile: DO NOT EDIT !*/ package org.javascool; class $(*F) { static String xsl = ' > $@
	@cat $^ | sed 's/"/\\"/g' | sed 's/\(.*\)/"\1\\n"+/' >> $@
	@echo '"";}' >> $@ 	

src/org/javascool/proglets.java : $(shell find src/proglet -name '*.java')
	@echo '/* Automatically generated by the makefile: DO NOT EDIT !*/ package org.javascool; class proglets { static String proglets[] = {' > $@
	@for f in `egrep -l 'implements[ \t]+(org.javascool.)?Proglet' $^` ; do echo $$f | sed 's/^src\/\(.*\)\.java$$/"\1",/' | sed 's/\//./g' ; done >> $@
	@echo '""}; }' >> $@

# Installation of used jars

ifeq ($(USER), vthierry)

TL=$(J5)/lib/tools.jar

lib/tools.jar : $(TL)
	@cp $^ $@

SX=/home/vthierry/bin/saxon.jar

lib/saxon.jar : $(SX)
	@cp $^ $@

endif

#####################################################################################################################################

# JavaScool doc generation

api: htm www/api 

www/api : $(SRC) $(DOC) makefile $(shell find src -name package.html) 
	@echo "make $@"
	@rm -rf $@ ; mkdir -p $@
	@for f in $(SRC) ; do mv $$f $$f.bak ; sed 's/\/\*\*\/ *public/\/\*public\*\//g' < $$f.bak > $$f ; touch -r $$f.bak $$f ; done
	@javadoc -quiet -public -nohelp -nodeprecated -nonavbar -nosince -notree -noindex -author -use -link http://download.oracle.com/javase/6/docs/api \
	 -windowtitle "Java's Cool v3" -d $@ $(SRC)
	@for f in $(SRC) ; do mv $$f $$f.bak ; sed 's/\/\*public\*\//\/\*\*\/public/g' < $$f.bak > $$f ; touch -r $$f.bak $$f ; rm $$f.bak ; done
	@for f in $(SRC) $(XSL) $(shell find src -name doc-files) ; do d=`echo $$f | sed 's/^src/$(subst /,\\/,$@)/'` ; mkdir -p `dirname $$d` ; cp -r $$f $$d ; done
	@for f in `find $@ -name '*.java' -o -name '*.jvs'` ; do mv $$f $$f.java ; java -jar lib/java2html.jar -srcfile $$f.java ; rm $$f.java ; done
	@rm -rf `find $@ -name .svn`
	@cd www ; rm -f sources.zip ; zip -9qr sources.zip api
	@echo ".. done: size = `du -s -B 1024 $@ | awk '{print $$1}'`Kbytes"

aps:
	@for f in $(SRC) ; do mv $$f $$f.bak ; sed 's/\/\*public\*\//\/\*\*\/public/g' < $$f.bak > $$f ; touch -r $$f.bak $$f ; rm $$f.bak ; done

#####################################################################################################################################

# Java doc generation

viewjdoc: jdoc
	@firefox $(PWD)/jdoc/index.html 

jdoc : jdochi jdocfolders jdoc/api/doc.tar.gz jdoc/base.tar.gz $(SRC) makefile $(shell find src -name package.html) 
	@echo "Good, dependences are ok and we now build the Javascool API Private Doc"
	@mkdir -p $@/APIJVS
	@echo "> Generating the JavaScool API Private Doc ..."
	@javadoc -quiet -private -nohelp -nodeprecated -notree -noindex -author -charset "UTF-8" -use -linkoffline ../api/ jdoc/api/ -windowtitle "Java's Cool v3" -d $@/APIJVS $(SRC)
	@echo "> Coping doc-file to the JavaScool API Doc ..."
	@for f in $(SRC) $(shell find src -name doc-files) ; do cp -r $$f `echo $$f | sed 's/^src/$(subst /,\\/,$@/APIJVS)/'` ; done
	@echo "> Generating colored source code ..."
	@for f in `find $@ -name '*.java'` ; do mv $$f $$f.java ; java -jar lib/java2html.jar -srcfile $$f.java ; rm $$f.java ; done
	@echo "> Delete tmp files ..."
	@rm -rf `find $@ -name .svn` 
	@echo "Fine, JDoc is now generated. Its size is `du -s -B 1048576 $@ | awk '{print $$1}'`Mbytes"
	@echo "To open JDoc, open in your browser jdoc/index.html and Read The Fine Manuel (RTFM)"

jdochi:
	@echo "                    JDoc Generator                      "
	@echo "  Welcome to the generator of the bigest Java Doc"
	@echo ""
	@echo " --------------------------------------------------------"
	@echo " | Copyright 2010 INRIA for JavaScool Doc               |"
	@echo " | Copyright 1993-2010 Oracle for Java API Doc          |"
	@echo " --------------------------------------------------------"
	@echo " "
	@echo " Distributed on GNU GPL V3                      "
	@echo " For more information : http://javascool.gforge.inria.fr"
	@echo " ________________________________________________________"
	@echo " "
	@echo "> Evaluate and build dependances ..."

jdocfolders:
	@mkdir -p jdoc/api

jdoc/api/doc.tar.gz:
	@echo "You need to build the Java Api Doc :  (This can make some time)"
	@echo "> Dowloading of the Java api doc ..."
	@wget http://www.philien.fr/jdoc/java_api_doc.tar.gz -O $@ -q
	@echo "> Uncompressing the Java api doc ..."
	@cd jdoc/api/;tar xzf ./doc.tar.gz;
	@echo "The Java api doc is build"

jdoc/base.tar.gz:
	@echo "You need to build the Doc Base : (This can make some time)"
	@echo "> Dowloading of the doc base ..."
	@wget http://www.philien.fr/jdoc/usefull.tar.gz -O $@ -q
	@echo "> Uncompressing the doc base ..."
	@cd jdoc/;tar xzf ./base.tar.gz;
	@echo "The doc base is build"

#####################################################################################################################################

# Web site files publication

wpub: api wraz
	@php -l www/*.php ; rm -f www/*~
	@-rsync --rsh='ssh -C' --archive --delete-excluded --exclude .svn/ --exclude index.php --exclude javascool.jar www/* scm.gforge.inria.fr:/home/groups/javascool/htdocs/v3 \
	 2>&1 | grep -v '^rsync: failed to set'
	@-rsync --rsh='ssh -C' www/index.php scm.gforge.inria.fr:/home/groups/javascool/htdocs/v3/.htindex.php
	@ssh scm.gforge.inria.fr 'sh -c "cd /home/groups/javascool/htdocs/v3 ; cat .htindex.php > index.php ; rm .htindex.php"'

# Jat file publication: WARNING this disseminates your new release all around the world !!!

jpub: jar
	@-rsync --rsh='ssh -C' www/javascool.jar scm.gforge.inria.fr:/home/groups/javascool/htdocs/v3

# Check the web site links 

wref: wpub
	@lib/run.sh org.javascool.LinkCheck -recursive http://javascool.gforge.inria.fr/v3/ | tee brokenlinks.txt

# Clean the web cache

wraz: 
	@wget -q -O - http://javascool.gforge.inria.fr?kezako=niquelekacheux

#####################################################################################################################################

# Useful links

jweb:
	@firefox http://javascool.gforge.inria.fr/v3

wiki:
	@firefox http://wiki.inria.fr/sciencinfolycee/JavaScool:ToDoList

glog :
	@firefox https://www.google.com/analytics

gref :
	@firefox https://www.google.com/webmasters/tools/dashboard

#####################################################################################################################################

#                                       System operation commands: TO BE USED WITH CARE !!!!                                        #

# This is used to access to web-site files

ssh :
	gnome-terminal -e "ssh scm.gforge.inria.fr 'cd /home/groups/javascool/htdocs ; bash -i'" 

ifeq ($(USER), vthierry)

# This is used to test www/index.php in local mode

php:
	@php -l www/index.php
	@make -f /home/vthierry/Work/enas/src/yava/makefile.http ROOT=`pwd`/www PAGE=index.php?page=api:org/javascool/package-summary.html show

# This is a remainder about what has been used to set the web site on v3

wv3 :
	@(echo '<script>' ; echo 'location.replace("./v3/index.php");' ; echo '</script>') > tmp.htm
	@rsync --rsh='ssh -C' tmp.htm scm.gforge.inria.fr:/home/groups/javascool/htdocs/index.html
	@firefox http://javascool.gforge.inria.fr
	@(echo '<script>' ; echo 'location.replace("../v3/index.php");' ; echo '</script>') > tmp.htm
	@rsync --rsh='ssh -C' tmp.htm scm.gforge.inria.fr:/home/groups/javascool/htdocs/proglet/index.html 
	@rsync --rsh='ssh -C' tmp.htm scm.gforge.inria.fr:/home/groups/javascool/htdocs/proglets/index.html 
	@firefox http://javascool.gforge.inria.fr
	@ssh facets.inria.fr '/bin/rm -rf /home/vthierry/javascool/* /home/vthierry/javascool/.[a-zA-Z0-1]*'
	@echo '<?php /* No web service in V3 ! */ header("Location:http://javascool.gforge.inria.fr"); ?>' > tmp.php	
	@rsync --rsh='ssh -C' tmp.php facets.inria.fr:javascool/index.php ; rm tmp.php
	@firefox http://facets.inria.fr/javascool

endif

# Check the site apache log

wlog:
	@firefox http://javascool.gforge.inria.fr/log

ifeq ($(USER), philien)

# Install the jdk 5 for philien

jdk5deb:
	@wget http://www.philien.fr/jdoc/jdk-1_5_0_22-linux-i586.bin -O jdk5install.bin -q
	@sudo chmod +x ./jdk5install.bin
	@sudo ./jdk5install.bin
	@sudo mkdir -p /usr/java/
	@sudo cp -r ./jdk1.5.0_22 /usr/java/
	@sudo rm ./jdk1.5.0_22/ -r
	@sudo rm ./jdk5install.bin

endif

# Useful insuperable commands (to be used with MUCH care):
#
# [1] resolve conflicts in favor of MY working version
# - svn up ; svn resolve --accept working . 
# [2] remove files marked as deleted
# - svn rm `svn status | grep '^!' | awk '{print $2}'` 
#

# MakeToolBar commands

please : cmp
	@lib/run.sh  org.javascooldev.MakeToolBar

done : 
	@echo '..done (Enter to close)' ; read cont

#####################################################################################################################################
#</pre><a name="readme"/><pre>

#: ********************************************************************************
#: *****                 JavaScool developer's readme                         *****
#: ********************************************************************************
#:
#: Welcome to the JavaScool V3 development bundle :
#:  please contact: philoumailabo@gmail.com,thierry.vieville@inria.fr for any info/request/..
#:
#:
#: [1] The javascool/javascool_V3/trunk/org.javascool file bundle description.
#: 
#: [1.1] Source files:
#: ./makefile                 : contains all compilation/publication/test commands
#: ./src/org/javascool/*.java : contains the javascool core and widget classes and doc-files
#: ./src/org/javascool/*.xslt : contains the javascool XSLT rules.
#: ./src/proglet/*/*.java     : contains the proglets classes and doc-files
#: ./src/org/javascooldev/*   : contains the javascool development tools
#:
#: [1.2] Web site files
#: src/.../doc-files          : contains all javascool and proglets corresponding resources (documentation, icons, ..)
#: www/index.php              : is the web site wrapper (unique http://javascool.gforge.inria.fr entry point)
#: www/documents              : contains extra documents for the web site
#: www/images                 : contains the web site icons
#: www/styles/*.css           : contains the web site CSS styles
#: www/documents              : contains extra documents for the web site and/or not included in the JAR file
#: www/api                    : is the makefile generated javadoc files, deleted on clean: do NOT edit
#: www/javascool.jar          : is the makefile generated javascool JAR, deleted on clean: do NOT edit
#:
#: [1.3] Lib files:
#: ./lib/run.sh               : simplifies the local use of saxon and javascool (Java main + performs xml2xml translation)
#: ./lib/*.jar                : are used jar for the present development
#: ./lib/manifest.mf          : is a makefile generated file: do NOT edit
#: 
#: [1.4] Other files
#: ./tst/*                    : contains local test files
#: ./J                        : convenient link to ./src/org/javascool
#: ./P                        : convenient link to ./src/proglet.
#: ./jdoc                     : convenient Java and JavaScool doc bundle for local use (make jdoc to generate it).
#:
#: [2] Makefile usage.
#:
#::Usage:
#::Development commands:
#:: make v3           : Run javascool'v3 from locally compiled clases
#:: make j3           : Run javascool'v3 from the constructed jar
#:: make doc          : Show the javadoc local bundle
#:: make svn          : Synchronize with the svn repository (update + commit)
#:: make clean        , Clean all intermediate files
#:: make usage        ; Show the makefile usage
#:: make what         ; Show the README information contains in this makefile
#:: make please       ; Show a toolbar to run make actions
#::System commands:
#:: make cmp          : Build the java classes
#:: make htm          : Build the documentation files
#:: make jar          : Build the java jar
#:: make api          : Build the java doc
#:: make api          : Rebuild source files after a java doc build failure
#:: make wpub         : Publish the present document release on the web site
#:: make jpub         : Publish the present javascool.jar release on the web site
#:: make wraz         , Clears the web site cache
#:: make wref         : Checks the web site broken links
#::Useful links:
#:: make jdoc         ; Build the convenient Java and JavaScool doc bundle for local use
#:: make jweb         , Opens the javascool web site
#:: make wiki         , Opens the javascool wiki
#:: make glog         , Connects to google analytics
#:: make gref         , Connects to google dashboard
# note: This makefile usage is fragible !! Take care. (here: ',' means run in background ':' run in external windows ';' do not run in the "please" toolbar)
#:
#: [3] Development tools used.
#:
#: [3.1] Usual linux commands:  cp du echo cat fig2dev firefox grep make php rm rsync sed ssh svn touch unzip
#: Installing these commands:
#: > (apt-get|yum) install bash coreutils firefox grep make openssh perl php-cli rsync sed transfig subversion unzip 
#:  while fig2dev (from transfig)is only used to generate .fig images, firefox
#:  while perl    (from perl)    is only used for lib/linkcheck
#:  while php     (from php-cli) is only used to check the php syntax
#:  while firefox                can be replaced by any other open-source convenient browser
#:
#: [3.2] Java development tools: java javac jarsigner javadoc keytool
#: Installing these commands run; e.g., yum or apt-get:
#: > yum java-1.6.0-openjdk-devel java-1.6.0-openjdk-javadoc
#: while we still need the JDK5, i.e.:
#: > cd /usr/java ; ./jdk-1_5_0_22-linux-i586.bin
#: or (to be validated):
#: > yum install java-1.5.0-gcj-devel
#:
#####################################################################################################################################

























#</pre>
